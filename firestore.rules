rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // =========================================================
    // ФУНКЦИИ-ПОМОЩНИКИ
    // =========================================================

    function isSignedIn() {
      return request.auth != null;
    }

    function isOwner(userId) {
      return isSignedIn() && request.auth.uid == userId;
    }

    function isSuperAdmin() {
      return isSignedIn() && 
        exists(/databases/$(database)/documents/config/app) &&
        request.auth.uid in get(/databases/$(database)/documents/config/app).data.superAdminIds;
    }

    function isCoachOf(resourceData) {
      return isSignedIn() && 
             "managedBy" in resourceData && 
             resourceData.managedBy == request.auth.uid;
    }

    function isRoomAdmin(roomData) {
      return isSignedIn() && (
        roomData.creator == request.auth.uid || 
        (roomData.keys().hasAll(['createdBy']) && roomData.createdBy == request.auth.uid) ||
        (roomData.keys().hasAll(['adminIds']) && request.auth.uid in roomData.adminIds)
      );
    }

    // =========================================================
    // КОЛЛЕКЦИЯ: USERS
    // =========================================================
    match /users/{userId} {
      // ЧТЕНИЕ: 
      allow read: if isSignedIn() || (resource.data.isGhost == true);

      // СОЗДАНИЕ:
      // Разрешаем создавать документ только с собственным UID.
      allow create: if isOwner(userId);
      
      // ОБНОВЛЕНИЕ: 
      // 1. Владелец может обновлять свой профиль.
      // 2. ВАЖНО: Запрещаем владельцу менять поля, связанные с миграцией профиля.
      //    Поля статистики (wins, losses, elo) оставляем доступными, так как 
      //    матчи пишутся через Cloud Functions, но в будущем может понадобиться прямой доступ.
      allow update: if (isOwner(userId) && 
                       !request.resource.data.diff(resource.data).affectedKeys()
                        .hasAny(['claimedFrom', 'ghostId', 'managedBy'])) 
                    || isSuperAdmin();
      
      // УДАЛЕНИЕ:
      allow delete: if isOwner(userId) || isSuperAdmin() || isCoachOf(resource.data);
    }

    // =========================================================
    // КОЛЛЕКЦИЯ: COMMUNITIES
    // =========================================================
    match /communities/{communityId} {
      allow read: if isSignedIn();
      allow write: if isSignedIn();
    }

    // =========================================================
    // КОЛЛЕКЦИИ: ROOMS
    // =========================================================
    match /rooms-pingpong/{roomId} {
      allow read: if isSignedIn() || resource.data.isPublic == true;
      allow create: if isSignedIn();
      allow update: if isSignedIn(); 
      allow delete: if isRoomAdmin(resource.data) || isSuperAdmin();
    }

    match /rooms-tennis/{roomId} {
      allow read: if isSignedIn() || resource.data.isPublic == true;
      allow create: if isSignedIn();
      allow update: if isSignedIn();
      allow delete: if isRoomAdmin(resource.data) || isSuperAdmin();
    }

    match /rooms-badminton/{roomId} {
      allow read: if isSignedIn() || resource.data.isPublic == true;
      allow create: if isSignedIn();
      allow update: if isSignedIn();
      allow delete: if isRoomAdmin(resource.data) || isSuperAdmin();
    }

    // =========================================================
    // КОЛЛЕКЦИИ: MATCHES
    // =========================================================
    match /matches-pingpong/{matchId} {
      allow read: if isSignedIn();
      allow write: if false; 
    }

    match /matches-tennis/{matchId} {
      allow read: if isSignedIn();
      allow write: if false; 
    }

    match /matches-badminton/{matchId} {
      allow read: if isSignedIn();
      allow write: if false; 
    }

    // =========================================================
    // КОЛЛЕКЦИЯ: TOURNAMENTS
    // =========================================================
    match /tournaments-pingpong/{tournamentId} {
      allow read, write: if isSignedIn();
    }
    
    match /tournaments-tennis/{tournamentId} {
      allow read, write: if isSignedIn();
    }
    
    match /tournaments-badminton/{tournamentId} {
      allow read, write: if isSignedIn();
    }

    // =========================================================
    // СИСТЕМНЫЕ КОНФИГИ
    // =========================================================
    match /config/{docId} {
      allow read: if true;
      allow write: if false;
    }
  }
}