rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // =========================================================
    // ФУНКЦИИ-ПОМОЩНИКИ
    // =========================================================

    function isSignedIn() {
      return request.auth != null;
    }

    function isOwner(userId) {
      return isSignedIn() && request.auth.uid == userId;
    }

    function isSuperAdmin() {
      return isSignedIn() && 
        exists(/databases/$(database)/documents/config/app) &&
        request.auth.uid in get(/databases/$(database)/documents/config/app).data.superAdminIds;
    }

    function isCoachOf(resourceData) {
      return isSignedIn() && 
             "managedBy" in resourceData && 
             resourceData.managedBy == request.auth.uid;
    }

    function isRoomAdmin(roomData) {
      return isSignedIn() && (
        roomData.creator == request.auth.uid || 
        (roomData.keys().hasAll(['createdBy']) && roomData.createdBy == request.auth.uid) ||
        (roomData.keys().hasAll(['adminIds']) && request.auth.uid in roomData.adminIds)
      );
    }

    // =========================================================
    // КОЛЛЕКЦИЯ: USERS
    // =========================================================
    match /users/{userId} {
      allow read: if isSignedIn() || (resource.data.isGhost == true);

      allow create: if isOwner(userId) || (
        isSignedIn() && 
        request.resource.data.isGhost == true && 
        request.resource.data.managedBy == request.auth.uid
      );
      
      allow update: if 
        // 1. Владелец может обновлять свой профиль (кроме защищенных полей)
        (isOwner(userId) && 
         !request.resource.data.diff(resource.data).affectedKeys()
          .hasAny(['claimedFrom', 'ghostId', 'managedBy'])) 
        || 
        // 2. Супер-админ или Тренер этого игрока
        isSuperAdmin() || 
        isCoachOf(resource.data) 
        ||
        // 3. ЛОГИКА ДРУЗЕЙ И ПРИГЛАШЕНИЙ
        // Разрешаем любому авторизованному пользователю обновлять ТОЛЬКО эти поля у других:
        (isSignedIn() && 
         request.resource.data.diff(resource.data).affectedKeys()
         .hasOnly(['rooms', 'incomingRequests', 'outgoingRequests', 'friends']));
      
      allow delete: if isOwner(userId) || isSuperAdmin() || isCoachOf(resource.data);
    }

    // =========================================================
    // КОЛЛЕКЦИЯ: COMMUNITIES
    // =========================================================
    match /communities/{communityId} {
      allow read: if isSignedIn();
      allow write: if isSignedIn();

      // Разрешаем чтение ленты
      match /feed/{feedId} {
        allow read: if isSignedIn();
        // Писать в ленту может только сервер (Cloud Functions), клиентам запрещено
        allow write: if false; 
      }
    }

    // =========================================================
    // КОЛЛЕКЦИИ: ROOMS
    // =========================================================
    match /rooms-pingpong/{roomId} {
      allow read: if isSignedIn() || resource.data.isPublic == true;
      allow create: if isSignedIn();
      
      allow update: if 
        isRoomAdmin(resource.data) || 
        (isSignedIn() && !request.resource.data.diff(resource.data).affectedKeys()
          .hasAny(['creator', 'createdBy', 'adminIds', 'kFactor', 'mode', 'isRanked']));
          
      allow delete: if isRoomAdmin(resource.data) || isSuperAdmin();
    }

    match /rooms-tennis/{roomId} {
      allow read: if isSignedIn() || resource.data.isPublic == true;
      allow create: if isSignedIn();
      
      allow update: if 
        isRoomAdmin(resource.data) || 
        (isSignedIn() && !request.resource.data.diff(resource.data).affectedKeys()
          .hasAny(['creator', 'createdBy', 'adminIds', 'kFactor', 'mode', 'isRanked']));
          
      allow delete: if isRoomAdmin(resource.data) || isSuperAdmin();
    }

    match /rooms-badminton/{roomId} {
      allow read: if isSignedIn() || resource.data.isPublic == true;
      allow create: if isSignedIn();
      
      allow update: if 
        isRoomAdmin(resource.data) || 
        (isSignedIn() && !request.resource.data.diff(resource.data).affectedKeys()
          .hasAny(['creator', 'createdBy', 'adminIds', 'kFactor', 'mode', 'isRanked']));
          
      allow delete: if isRoomAdmin(resource.data) || isSuperAdmin();
    }

    // =========================================================
    // КОЛЛЕКЦИИ: MATCHES
    // =========================================================
    match /matches-pingpong/{matchId} {
      allow read: if isSignedIn();
      allow write: if false; 
    }

    match /matches-tennis/{matchId} {
      allow read: if isSignedIn();
      allow write: if false; 
    }

    match /matches-badminton/{matchId} {
      allow read: if isSignedIn();
      allow write: if false; 
    }

    // =========================================================
    // КОЛЛЕКЦИЯ: TOURNAMENTS
    // =========================================================
    match /tournaments-pingpong/{tournamentId} {
      allow read, write: if isSignedIn();
    }
    
    match /tournaments-tennis/{tournamentId} {
      allow read, write: if isSignedIn();
    }
    
    match /tournaments-badminton/{tournamentId} {
      allow read, write: if isSignedIn();
    }

    // =========================================================
    // СИСТЕМНЫЕ КОНФИГИ
    // =========================================================
    match /config/{docId} {
      allow read: if true;
      allow write: if false;
    }
  }
}